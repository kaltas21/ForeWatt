version: "3.9"

services:
  api:
    build: ./api
    container_name: forewatt_api_${USER_NAME}
    env_file: .env
    ports:
      - "${API_PORT}:8000"
    depends_on:
      - influxdb
      - mlflow
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow:5050
    networks:
      - forewatt_net

  dashboard:
    build: ./dashboard
    container_name: forewatt_dashboard_${USER_NAME}
    env_file: .env
    ports:
      - "${DASHBOARD_PORT}:8501"
    depends_on:
      - api
      - mlflow
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow:5050
    networks:
      - forewatt_net

  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.16.0
    container_name: forewatt_mlflow_${USER_NAME}
    env_file: .env
    command: >
      mlflow server
      --backend-store-uri sqlite:////mlflow/mlflow.db
      --default-artifact-root /mlflow/artifacts
      --host 0.0.0.0
      --port 5050
    volumes:
      - ./mlflow:/mlflow
    ports:
      - "${MLFLOW_PORT}:5050"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:5050/"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - forewatt_net

  influxdb:
    image: influxdb:2.7
    container_name: forewatt_influxdb_${USER_NAME}
    env_file: .env
    ports:
      - "${INFLUXDB_PORT}:8086"
    volumes:
      - ./data/influx:/var/lib/influxdb2
    networks:
      - forewatt_net

networks:
  forewatt_net:
    driver: bridge
